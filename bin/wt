#!/bin/sh

set -e

print_usage () {
	echo 'Required args not supplied.'
	echo '\nUsage:\n'
	echo 'wt <add|a> [worktree_dir]'
	echo 'wt <remove|rm>'
	echo 'wt <clone> <remote-url> [destination]'
	exit 1
}

if [ $# -eq 0 ]; then
	print_usage
fi

add () {
	worktree_dir=$1
	git worktree add $worktree_dir $(
		git branch --list | \
		awk '{ print $NF }' | \
		fzf
	)
}

remove () {
	to_remove=$(
		git worktree list --porcelain | \
		grep worktree | \
		awk '{print $NF}' | \
		fzf
	)
	git worktree remove $to_remove 
	echo "Removed worktree:" $to_remove
}

clone () {
	remote_url=$1
	destination=$2
	clone_dir=$(echo $(basename $remote_url) | awk -F '.' '{ print $1 }')

	if [ -n "$destination" ]; then
		clone_dir=$destination
	fi

	git clone --bare $remote_url $clone_dir
	git -C $clone_dir worktree add main
}

action=$1
case $action in
	"add"|"a")
		add $2
		;;
	"remove"|"rm")
		remove
		;;
	"clone")
		if [ $# -lt 2 ]; then
			echo "Remote URL required."
			print_usage
		fi
		clone $2 $3
		;;
	*)
		echo "Invalid action: $action"
		print_usage
		;;
esac

